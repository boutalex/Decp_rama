<!DOCTYPE html>

<html lang="fr" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>general_process.SourceProcess &#8212; Documentation DECP_doc 1.0.0</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=05dadb3a"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=bf059b8c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Code source de general_process.SourceProcess</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span>
<span class="kn">import</span> <span class="nn">wget</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">xml</span>
<span class="kn">import</span> <span class="nn">xmlschema</span>
<span class="kn">import</span> <span class="nn">jsonschema</span>
<span class="kn">from</span> <span class="nn">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span><span class="p">,</span><span class="n">Draft7Validator</span><span class="p">,</span><span class="n">Draft202012Validator</span>
<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xmltodict</span>
<span class="kn">import</span> <span class="nn">dict2xml</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<div class="viewcode-block" id="SourceProcess">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess">[docs]</a>
<span class="k">class</span> <span class="nc">SourceProcess</span><span class="p">:</span>
    
    <span class="n">columns_marche_2022</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;acheteur&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nature&#39;</span><span class="p">,</span>
        <span class="s1">&#39;objet&#39;</span><span class="p">,</span>
        <span class="s1">&#39;codeCPV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;techniques&#39;</span><span class="p">,</span>
        <span class="s1">&#39;procedure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dateNotification&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lieuExecution&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dureeMois&#39;</span><span class="p">,</span>
        <span class="s1">&#39;modalitesExecution&#39;</span><span class="p">,</span>
        <span class="s1">&#39;considerationsSociales&#39;</span><span class="p">,</span>
        <span class="s1">&#39;considerationsEnvironnementales&#39;</span><span class="p">,</span>
        <span class="s1">&#39;marcheInnovant&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ccag&#39;</span><span class="p">,</span>
        <span class="s1">&#39;offresRecues&#39;</span><span class="p">,</span>
        <span class="s1">&#39;montant&#39;</span><span class="p">,</span>
        <span class="s1">&#39;formePrix&#39;</span><span class="p">,</span>
        <span class="s1">&#39;offresRecues&#39;</span><span class="p">,</span>
        <span class="s1">&#39;typesPrix&#39;</span><span class="p">,</span>
        <span class="s1">&#39;attributionAvance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;titulaires&#39;</span><span class="p">,</span>
        <span class="s1">&#39;typeGroupementOperateurs&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sousTraitanceDeclaree&#39;</span><span class="p">,</span>
        <span class="s1">&#39;datePublicationDonnees&#39;</span>
    <span class="p">])</span>
    
    <span class="n">colums_marche_opt_2022</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;idAccordCadre&#39;</span><span class="p">,</span>
        <span class="s1">&#39;origineUE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;origineFrance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tauxAvance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;actesSousTraitance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;modifications&#39;</span><span class="p">,</span>
        <span class="s1">&#39;modificationsActesSousTraitance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_type&#39;</span>
        
    <span class="p">])</span>
    
    <span class="n">columns_concession_2022</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;autoriteConcedante&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nature&#39;</span><span class="p">,</span>
        <span class="s1">&#39;objet&#39;</span><span class="p">,</span>
        <span class="s1">&#39;procedure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dureeMois&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dateDebutExecution&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dateSignature&#39;</span><span class="p">,</span>
        <span class="s1">&#39;considerationsSociales&#39;</span><span class="p">,</span>
        <span class="s1">&#39;considerationsEnvironnementales&#39;</span><span class="p">,</span>
        <span class="s1">&#39;concessionnaires&#39;</span><span class="p">,</span>
        <span class="s1">&#39;valeurGlobale&#39;</span><span class="p">,</span>
        <span class="s1">&#39;montantSubventionPublique&#39;</span><span class="p">,</span>
        <span class="s1">&#39;datePublicationDonnees&#39;</span><span class="p">,</span>
        <span class="s1">&#39;donneesExecution&#39;</span>
    <span class="p">])</span>
    
    <span class="n">columns_concession_opt_2022</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;modifications&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_type&#39;</span>
    <span class="p">])</span>

    <span class="n">columns_marche_2019</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nature&#39;</span><span class="p">,</span>
        <span class="s1">&#39;objet&#39;</span><span class="p">,</span>
        <span class="s1">&#39;codeCPV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;procedure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lieuExecution&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dureeMois&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dateNotification&#39;</span><span class="p">,</span>
        <span class="s1">&#39;datePublicationDonnees&#39;</span><span class="p">,</span>
        <span class="s1">&#39;montant&#39;</span><span class="p">,</span>
        <span class="s1">&#39;formePrix&#39;</span><span class="p">,</span>
        <span class="s1">&#39;titulaires&#39;</span><span class="p">,</span>
        <span class="s1">&#39;source&#39;</span><span class="p">,</span>
        <span class="s1">&#39;acheteur&#39;</span>
    <span class="p">])</span>

    <span class="n">colums_marche_opt_2019</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;modifications&#39;</span>
    <span class="p">])</span>

    <span class="n">columns_concession_2019</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nature&#39;</span><span class="p">,</span>
        <span class="s1">&#39;typeContrat&#39;</span><span class="p">,</span>
        <span class="s1">&#39;objet&#39;</span><span class="p">,</span>
        <span class="s1">&#39;codeCPV&#39;</span><span class="p">,</span>
        <span class="s1">&#39;procedure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lieuExecution&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dureeMois&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dateNotification&#39;</span><span class="p">,</span>
        <span class="s1">&#39;datePublicationDonnees&#39;</span><span class="p">,</span>
        <span class="s1">&#39;montant&#39;</span><span class="p">,</span>
        <span class="s1">&#39;formePrix&#39;</span><span class="p">,</span>
        <span class="s1">&#39;titulaires&#39;</span><span class="p">,</span>
        <span class="s1">&#39;source&#39;</span><span class="p">,</span>
        <span class="s1">&#39;acheteur&#39;</span><span class="p">,</span>
        <span class="s1">&#39;modifications&#39;</span>
    <span class="p">])</span>

    <span class="n">colums_concession_opt_2019</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s1">&#39;modifications&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uuid&#39;</span>
    <span class="p">])</span>
<span class="w">   </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;La classe SourceProcess est une classe abstraite qui sert de parent à chaque classe enfant de</span>
<span class="sd">    sources. Elle sert à définir le cas général des étapes de traitement d&#39;une source : création des</span>
<span class="sd">    variables de classe (__init__), nettoyage des dossiers de la source (_clean_metadata_folder),</span>
<span class="sd">    récupération des URLs (_url_init), get, convert et fix.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span><span class="n">data_format</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;L&#39;étape __init__ crée les variables associées à la classe SourceProcess : key, source,</span>
<span class="sd">        format, df, title, url, cle_api et metadata.&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ÉTAPE INIT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">data_format</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;metadata/metadata.json&quot;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;format&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;url_source&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Lavage des dossiers de la source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_metadata_folder</span><span class="p">()</span>

        <span class="c1"># Récupération des urls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url_init</span><span class="p">()</span> 

        <span class="c1"># Liste des dictionnaires pour l&#39;étape de nettoyage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored_marche</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored_concession</span><span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_marche</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_concession</span> <span class="o">=</span> <span class="p">[]</span>


    <span class="k">def</span> <span class="nf">_clean_metadata_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;La fonction _clean_metadata_folder permet le nettoyage de /metadata/{self.source}&quot;&quot;&quot;</span>
        <span class="c1"># Lavage des dossiers dans metadata</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Début du nettoyage de metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nettoyage metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2"> OK&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_url_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;_url_init permet la récupération de l&#39;ensemble des url des fichiers qui doivent être</span>
<span class="sd">        téléchargés pour une source. Ces urls sont conservés dans self.metadata.&quot;&quot;&quot;</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialisation&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old_metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cle_api</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;cle_api&quot;</span><span class="p">]</span>
        <span class="c1">#Liste contenant les urls à partir desquels on télécharge les fichiers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cle_api</span><span class="o">==</span><span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">url_source</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metadata_file</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cle_api</span><span class="p">))</span>
           
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialisation finie&quot;</span><span class="p">)</span>
    

<div class="viewcode-block" id="SourceProcess.create_metadata_file">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.create_metadata_file">[docs]</a>
    <span class="k">def</span> <span class="nf">create_metadata_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction réalisant le téléchargement des métadatas, la copie des</span>
<span class="sd">        fichiers métadatas et la création des listes contenant les titres</span>
<span class="sd">        et les urls des fichiers.</span>
<span class="sd">        n: nombre de clé api (=nombre de tour dans la boucle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Début de la récupération de la liste des url&quot;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="p">[]</span>  
        <span class="n">url</span> <span class="o">=</span> <span class="p">[]</span>    
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1">#Téléchargement du fichier de metadata de self.source et création de la 1ere variable json pour la comparaison </span>
            <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://www.data.gouv.fr/api/1/datasets/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cle_api</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ref_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">ressources</span> <span class="o">=</span> <span class="n">ref_json</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span>

            <span class="c1">#Creation de la deuxième variable json pour la comparaison si le fichier old_metadata existe</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old_metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/old_metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old_metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/old_metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fl</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ouverture fichier&quot;</span><span class="p">)</span>
                    <span class="n">refjson</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
                <span class="n">old_ressources</span> <span class="o">=</span> <span class="n">refjson</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;affectation faite&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_ressources</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1">#Création de la liste des urls selon 2 cas: 1er téléchargement, i-nième téléchargement</span>
            <span class="k">if</span> <span class="n">old_ressources</span><span class="o">==</span><span class="p">[]:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ressources</span> <span class="k">if</span>
                            <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;xml&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">))]</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ressources</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">url</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_date_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">title</span><span class="p">,</span> <span class="n">ressources</span><span class="p">,</span> <span class="n">old_ressources</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Les urls dont le contenu a été modifié sont: &quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

            <span class="c1">#Cas où les fichiers old_metadata existent: on écrit dedans à nouveau</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old_metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/old_metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
                    <span class="n">contenu</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old_metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/old_metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">destination_file</span><span class="p">:</span>
                    <span class="n">destination_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contenu</span><span class="p">)</span>
            <span class="c1">#Cas où les fichiers old_metadata n&#39;existent pas: on fait une copie</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;old_metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/old_metadata_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old_metadata/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Récupération des url OK&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">url</span><span class="p">,</span><span class="n">title</span></div>



<div class="viewcode-block" id="SourceProcess.check_date_file">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.check_date_file">[docs]</a>
    <span class="k">def</span> <span class="nf">check_date_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">new_ressources</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span><span class="n">old_ressources</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction vérifiant si la date de dernière modification des fichiers ressources </span>
<span class="sd">        dans les metadatas est strictement antérieure à la date de dernière modification.</span>
<span class="sd">        @url: la liste contenant les liens pour télécharger les fichiers</span>
<span class="sd">        @new_ressources: dictionnaire correspondant au champ &quot;resources&quot; dans le fichier metadata de la source</span>
<span class="sd">        @old_ressources: dictionnaire correspondant au champ &quot;resources&quot; dans le fichier old_metadata de la source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_ressources</span><span class="p">)):</span>
            <span class="c1">#condition1 : test si les nouvelles métadonnées sont plus récentes que les anciennes </span>
            <span class="n">condition1</span><span class="o">=</span><span class="n">new_ressources</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">old_ressources</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span>
            <span class="c1">#condition2 : vérification de l&#39;extension</span>
            <span class="n">condition2</span><span class="o">=</span><span class="p">(</span><span class="n">new_ressources</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;xml&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">new_ressources</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">condition1</span> <span class="ow">and</span> <span class="n">condition2</span> <span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_ressources</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;url&quot;</span><span class="p">]]</span> 
                <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_ressources</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]]</span> 
        <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span>            </div>



<div class="viewcode-block" id="SourceProcess.get">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Étape get qui permet le lavage du dossier sources/{self.source} et </span>
<span class="sd">        la récupération de l&#39;ensemble des fichiers présents sur chaque url.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ÉTAPE GET&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Début du téléchargement : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2"> fichier(s)&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SELF.URL:&quot;</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cle_api</span><span class="o">==</span><span class="p">[]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pas  de clé api&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_without_metadata</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Verification de l&#39;existence d&#39;un eventuel doublon + nettoyage + </span>
            <span class="c1"># téléchargement du nouveau fichier</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fichier : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> existe déjà, nettoyage du doublon &quot;</span><span class="p">)</span>
                    <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Problème de téléchargement du fichier &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Téléchargement : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2"> fichier(s) OK&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="SourceProcess.download_without_metadata">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.download_without_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">download_without_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction téléchargeant un fichier n&#39;ayant pas de clé api. Par conséquent, le</span>
<span class="sd">        téléchargement s&#39;effectue grâce à l&#39;url dans l&#39;attribut url_source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nom_fichiers</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Obtenir le chemin de l&#39;URL et extraire le nom du fichier</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nom_fichiers</span><span class="o">!=</span><span class="p">[]:</span>   <span class="c1">#Dossier non vide</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">nom_fichiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Le fichier </span><span class="si">{</span><span class="n">nom_fichiers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> était présent. Il a été supprimé&quot;</span><span class="p">)</span>
            <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="p">[</span> <span class="n">file_name</span> <span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Titre des fichiers : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#Le dossier est vide car il s&#39;agit du 1er téléchargement. Téléchargement </span>
        <span class="c1">#dans le dossier puis affectation du nom du fichier à l&#39;attribut titre</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="p">[</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Titre des fichiers : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



    <span class="c1"># def clean(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Fonction réalisant un tri sur le format 2022 ou le format 2019 en complétant</span>
    <span class="c1">#     les 3 dictionnaires et permettre la conversion en dataframe pour plus tard.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     logging.info(&quot; ÉTAPE CLEAN&quot;)</span>
    <span class="c1">#     logging.info(&quot;Début du tri des nouveaux fichiers&quot;)</span>
    <span class="c1">#     #Ouverture des fichiers</span>
    <span class="c1">#     dico = {}</span>
    <span class="c1">#     for i in range(len(self.title)):            </span>
    <span class="c1">#         if self.format == &#39;xml&#39;:</span>
    <span class="c1">#             #Vérification du schéma xml</span>
    <span class="c1">#             scheme_path = &#39;schemes/schema_decp_v2.0.2.xsd&#39;</span>
    <span class="c1">#             if not self.check(None,f&quot;sources/{self.source}/{self.title[i]}&quot;):</span>
    <span class="c1">#                 logging.warning(f&quot;sources/{self.source}/{self.title[i]} not a valide xml&quot;)</span>
    <span class="c1">#                 continue</span>
    <span class="c1">#             try:</span>
    <span class="c1">#                 with open(f&quot;sources/{self.source}/{self.title[i]}&quot;, encoding=&#39;utf-8&#39;) as xml_file:</span>
    <span class="c1">#                     dico = xmltodict.parse(xml_file.read(), dict_constructor=dict, \</span>
    <span class="c1">#                                            force_list=(&#39;marche&#39;,&#39;titulaires&#39;, &#39;modifications&#39;, &#39;actesSousTraitance&#39;,</span>
    <span class="c1">#                                            &#39;modificationsActesSousTraitance&#39;, &#39;typePrix&#39;,&#39;considerationEnvironnementale&#39;,</span>
    <span class="c1">#                                            &#39;modaliteExecution&#39;))</span>
    <span class="c1">#             except Exception as err:</span>
    <span class="c1">#                 logging.error(f&quot;Exception lors du chargement du fichier xml {self.title[i]} - {err}&quot;)</span>

    <span class="c1">#         elif self.format == &#39;json&#39;:</span>
    <span class="c1">#             #Vérification du schéma json</span>
    <span class="c1">#             scheme_path = &#39;schemes/schema_decp_v2.0.2.json&#39;</span>
    <span class="c1">#             if not self.check(f&quot;sources/{self.source}/{self.title[i]}&quot;, None):</span>
    <span class="c1">#                 logging.warning(f&quot;sources/{self.source}/{self.title[i]} not a valid json&quot;)</span>
    <span class="c1">#                 continue</span>
    <span class="c1">#             try:</span>
    <span class="c1">#                 with open(f&quot;sources/{self.source}/{self.title[i]}&quot;, encoding=&quot;utf-8&quot;) as json_file1:</span>
    <span class="c1">#                     dico = json.load(json_file1)</span>
    <span class="c1">#             except Exception as err:</span>
    <span class="c1">#                 logging.error(f&quot;Exception lors du chargement du fichier json {self.title[i]} - {err}&quot;)</span>
    <span class="c1">#         self.champs_plus = set()</span>
    <span class="c1">#         self.champs_moins = set()</span>
    <span class="c1">#         self.tri_format(dico,self.title[i])    #On obtient 3 listes de dico qui sont mises à jour à chaque tour de boucle</span>
            
    <span class="c1">#     logging.info(&quot;Fin du tri selon le format&quot;)</span>
    <span class="c1">#     logging.info(&quot;Nettoyage OK&quot;)</span>

<div class="viewcode-block" id="SourceProcess.clean">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.clean">[docs]</a>
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction réalisant un tri sur le format 2022 ou le format 2019 en complétant</span>
<span class="sd">        les 3 dictionnaires et permettre la conversion en dataframe pour plus tard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; ÉTAPE CLEAN&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Début du tri des nouveaux fichiers&quot;</span><span class="p">)</span>
        <span class="c1">#Ouverture des fichiers</span>
        <span class="n">dico</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)):</span>            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;xml&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xml_file</span><span class="p">:</span>
                        <span class="n">dico</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">dict_constructor</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> \
                                               <span class="n">force_list</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;marche&#39;</span><span class="p">,</span><span class="s1">&#39;titulaires&#39;</span><span class="p">,</span> <span class="s1">&#39;modifications&#39;</span><span class="p">,</span> <span class="s1">&#39;actesSousTraitance&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;modificationsActesSousTraitance&#39;</span><span class="p">,</span> <span class="s1">&#39;typePrix&#39;</span><span class="p">,</span><span class="s1">&#39;considerationEnvironnementale&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;modaliteExecution&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception lors du chargement du fichier xml </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file1</span><span class="p">:</span>
                        <span class="n">dico</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception lors du chargement du fichier json </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tri_format</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>    <span class="c1">#On obtient 2 fichiers qui sont mis jour à chaque tour de boucle</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;clean: Balise &#39;marches&#39; inexistante&quot;</span><span class="p">)</span>
            
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fin du tri selon le format&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Nettoyage OK&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="SourceProcess.tri_format">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.tri_format">[docs]</a>
    <span class="k">def</span> <span class="nf">tri_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dico</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cette fonction permet de vérifier la structure du dictionnaire fournit en</span>
<span class="sd">        entrée. Si un champ est manquant dans un marché ou une concession, ce dernier</span>
<span class="sd">        est stocké dans une liste pour un éventuel traitement.</span>
<span class="sd">        @dico : dictionnaire , il s&#39;agit d&#39;un dictionnaire avec 2 clés: &#39;marchés&#39; et &#39;contrat-concession&#39;</span>
<span class="sd">        @file_name : nom du fichier où sont stockés les fichiers non valides et ignorés</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;marche&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marche&#39;</span><span class="p">])</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_marche</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marche&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>
                <span class="n">dico_test</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;marches&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marche&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_marche</span><span class="p">,</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_concession</span><span class="p">}}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">dico_test</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_marche</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marche&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored_marche</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marche&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>
                <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>


        <span class="k">if</span> <span class="s1">&#39;contrat-concession&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">])</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_concession</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span>
                <span class="n">dico_test</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;marches&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marche&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_marche</span><span class="p">,</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_concession</span><span class="p">}}</span>


                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">dico_test</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_concession</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored_concession</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span>
                <span class="n">m</span><span class="o">+=</span><span class="mi">1</span>
           

        <span class="c1"># Structure du nouveau fichier JSON, création des dictionnaires valides et invalides</span>
        <span class="n">jsonfile1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;marches&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marche&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_marche</span><span class="p">,</span> <span class="s1">&#39;contrat-concession&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_concession</span><span class="p">}}</span>
        <span class="n">jsonfile2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;marches&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marche&#39;</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored_marche</span><span class="p">,</span> <span class="s1">&#39;contrat-concession&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored_concession</span><span class="p">}}</span>

        <span class="c1">#Creation des dossiers</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tri&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tri/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

        <span class="c1">#Ecriture dans les nouveaux fichiers</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tri/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">/bons_marches_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_f1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ouverture fichier 1er&quot;</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jsonfile1</span><span class="p">,</span> <span class="n">new_f1</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tri/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">/mauvais_marches_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_f2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ouverture fichier 2eme&quot;</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jsonfile2</span><span class="p">,</span> <span class="n">new_f2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nombre de marchés et concessions invalides dans </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored_marche</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored_concession</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nombre de marchés et de concessions valides dans </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_marche</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_concession</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span></div>

    

<span class="c1"># def erreurs_acceptables():   #il faut ajouter une colonne source </span>
<span class="c1">#     marches_a_ajouter = []</span>
<span class="c1">#     with open(f&#39;data/mauvais_marches.json&#39;, &#39;r&#39;, encoding =&#39;utf8&#39;) as f :</span>
<span class="c1">#         bad_file = json.dumps(f)</span>
<span class="c1">#     if &quot;marche&quot; in bad_file[&quot;marches&quot;]:</span>
<span class="c1">#         for i in range(len(bad_file[&quot;marches&quot;])): </span>

<span class="c1">#     if &#39;concession-contrat&#39; in bad_file[&quot;marches&quot;][&#39;concession-contrat&#39;]:</span>
<span class="c1">#         for i in range(len(bad_file[&quot;marches&quot;][&#39;concession-contrat&#39;])): </span>
        





    <span class="c1"># def tri_format(self, dico:dict, file_name:str):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Cette fonction permet de vérifier la structure du dictionnaire fournit en</span>
    <span class="c1">#     entrée. Si un champ est manquant dans un marché ou une concession, ce dernier</span>
    <span class="c1">#     est stocké dans une liste pour un éventuel traitement.</span>
    <span class="c1">#     @dico : dictionnaire </span>
    <span class="c1">#     @file_name : nom du fichier où sont stockés les fichiers non valides et ignorés</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if &#39;marches&#39; in dico:</span>
    <span class="c1">#         if &#39;marche&#39; in dico[&#39;marches&#39;]:  #format 2022</span>
    <span class="c1">#             for m in dico[&#39;marches&#39;][&#39;marche&#39;]:</span>
    <span class="c1">#                 if self._has_all_field_and_date_2024(m, &#39;marche&#39;):</span>
    <span class="c1">#                     self.dico_2022_marche.append(m)</span>
    <span class="c1">#                 else:                   </span>
    <span class="c1">#                     self.dico_ignored.append(m)</span>

    <span class="c1">#         if &#39;contrat-concession&#39; in dico[&#39;marches&#39;]:</span>
    <span class="c1">#             for m in dico[&#39;marches&#39;][&#39;contrat-concession&#39;]:</span>
    <span class="c1">#                 if self._has_all_field_and_date_2024(m, &#39;contrat-concession&#39;):</span>
    <span class="c1">#                     self.dico_2022_concession.append(m)</span>
    <span class="c1">#                 else:</span>
    <span class="c1">#                     self.dico_ignored.append(m)</span>

    <span class="c1">#         if (&#39;marche&#39; not in dico[&#39;marches&#39;]) and (&#39;contrat-concession&#39; not in dico[&#39;marches&#39;]):  #format 2019</span>
    <span class="c1">#             for m in dico[&#39;marches&#39;]:</span>
    <span class="c1">#                 if self._has_all_field_and_date_2019(m):                </span>
    <span class="c1">#                     self.dico_2019.append(m)</span>
    <span class="c1">#                 else:</span>
    <span class="c1">#                     self.dico_ignored.append(m)</span>

    <span class="c1">#     else:</span>
    <span class="c1">#         logging.error(&quot;Balise &#39;marches&#39; inexistante&quot;)</span>
    <span class="c1">#         dico.clear()</span>
    <span class="c1">#     if len(self.champs_plus)&gt;0:</span>
    <span class="c1">#         logging.info(f&quot;Dans le fichier {file_name}, les champs en plus sont: {self.champs_plus} &quot;)</span>
    <span class="c1">#     if len(self.champs_moins)&gt;0:</span>
    <span class="c1">#         logging.info(f&quot;Dans le fichier {file_name}, les champs en moins sont: {self.champs_moins} &quot;)</span>
    <span class="c1">#     if len(self.dico_ignored)&gt;0:</span>
    <span class="c1">#         logging.info(f&quot;Nombre de marchés invalides dans {file_name}: {len(self.dico_ignored)} &quot;)</span>
    

    <span class="k">def</span> <span class="nf">_has_all_field_and_date_2019</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction vérifiant qu&#39;un marché/concession possède bel et bien toutes </span>
<span class="sd">        les colonnes requises par notre schéma. Il vérifie également que les </span>
<span class="sd">        dates contenues dans le marché/concession soient postérieures à 2024.</span>
<span class="sd">        @record : marché/concession que l&#39;on souhaite traiter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">liste_marche</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Marché&#39;</span><span class="p">,</span><span class="s1">&#39;Marché de partenariat&#39;</span><span class="p">,</span> <span class="s1">&#39;Accord-cadre&#39;</span><span class="p">,</span> <span class="s1">&#39;Marché subséquent&#39;</span><span class="p">,</span><span class="s1">&#39;MARCHE&#39;</span><span class="p">]</span>
        <span class="n">liste_concession</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Concession de travaux&#39;</span><span class="p">,</span>  <span class="s1">&#39;Concession de service&#39;</span><span class="p">,</span> <span class="s1">&#39;Concession de service public&#39;</span><span class="p">,</span> <span class="s1">&#39;Délégation de service public&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;nature&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">liste_marche</span> <span class="p">:</span> <span class="c1">#Il faudra modifier à l&#39;appel de sorte à avoir la nature : marché</span>
            <span class="n">champs_differents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="c1">#Complémentaire de l&#39;intersection entre les champs du dictionnaire et les champs obligatoires </span>
            <span class="n">champs_differents</span> <span class="o">=</span> <span class="n">champs_differents</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_marche_2019</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_differents</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">champs_en_moins</span> <span class="o">=</span> <span class="n">champs_differents</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_marche_2019</span> <span class="c1">#On récupère seulement les champs obligatoires manquants</span>
                <span class="n">champs_en_plus</span> <span class="o">=</span> <span class="n">champs_differents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colums_marche_opt_2019</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">champs_en_moins</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_en_moins</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_en_plus</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">champs_moins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">champs_moins</span> <span class="o">|</span> <span class="n">champs_en_moins</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">champs_plus</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">champs_plus</span>  <span class="o">|</span> <span class="n">champs_en_plus</span>
                    <span class="c1"># logging.info(f&quot;Voici les champs en moins :{champs_en_moins}&quot;)</span>
                    <span class="c1"># logging.info(f&quot;Voici les champs en plus :{champs_en_plus}&quot;)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tous les champs sont valides.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;nature&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">liste_concession</span> <span class="p">:</span>
            <span class="n">champs_differents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="c1">#Complémentaire de l&#39;intersection entre les champs du dictionnaire et les champs obligatoires </span>
            <span class="n">champs_differents</span> <span class="o">=</span> <span class="n">champs_differents</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_concession_2019</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_differents</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">champs_en_moins</span> <span class="o">=</span> <span class="n">champs_differents</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_concession_2019</span> <span class="c1">#On récupère seulement les champs obligatoires manquants</span>
                <span class="n">champs_en_plus</span> <span class="o">=</span> <span class="n">champs_differents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colums_concession_opt_2019</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">champs_en_moins</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_en_moins</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_en_plus</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">champs_moins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">champs_moins</span> <span class="o">|</span> <span class="n">champs_en_moins</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">champs_plus</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">champs_plus</span>  <span class="o">|</span> <span class="n">champs_en_plus</span>
                    <span class="c1">#logging.info(f&quot;Voici les champs en moins :{champs_en_moins}&quot;)</span>
                    <span class="c1">#logging.info(f&quot;Voici les champs en plus :{champs_en_plus}&quot;)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tous les champs sont valides.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    
    <span class="k">def</span> <span class="nf">_has_all_field_and_date_2024</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">record_type</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction vérifiant qu&#39;un marché/concession possède toutes les colonnes </span>
<span class="sd">        requises par notre schéma. Il vérifie également que les </span>
<span class="sd">        dates contenues dans le marché/concession soient postérieures à 2024.</span>
<span class="sd">        @record : marché/concession que l&#39;on souhaite traiter</span>
<span class="sd">        @record_type : type du marché (marché/concession)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">record_type</span> <span class="o">==</span> <span class="s1">&#39;marche&#39;</span><span class="p">:</span>
            <span class="n">champs_differents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="c1">#Complémentaire de l&#39;intersection entre les champs du dictionnaire et les champs obligatoires</span>
            <span class="n">champs_differents</span> <span class="o">=</span> <span class="n">champs_differents</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_marche_2022</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_differents</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">champs_en_moins</span> <span class="o">=</span> <span class="n">champs_differents</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_marche_2022</span> <span class="c1">#On récupère seulement les champs obligatoires manquants</span>
                <span class="n">champs_en_plus</span> <span class="o">=</span> <span class="n">champs_differents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colums_marche_opt_2022</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">champs_en_moins</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_en_moins</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_en_plus</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">champs_moins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">champs_moins</span> <span class="o">|</span> <span class="n">champs_en_moins</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">champs_plus</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">champs_plus</span>  <span class="o">|</span> <span class="n">champs_en_plus</span>
                    <span class="k">return</span> <span class="kc">False</span>
                    <span class="c1"># logging.info(f&quot;Voici les champs en moins :{champs_en_moins}&quot;)</span>
                    <span class="c1"># logging.info(f&quot;Voici les champs en plus :{champs_en_plus}&quot;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dictionnaire valide au format 2024&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">record_type</span> <span class="o">==</span> <span class="s1">&#39;contrat-concession&#39;</span><span class="p">:</span>
            <span class="n">champs_differents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="c1">#Complémentaire de l&#39;intersection entre les champs du dictionnaire et les champs obligatoires</span>
            <span class="n">champs_differents</span> <span class="o">=</span> <span class="n">champs_differents</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_concession_2022</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_differents</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">champs_en_moins</span> <span class="o">=</span> <span class="n">champs_differents</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_concession_2022</span> <span class="c1">#On récupère seulement les champs obligatoires manquants</span>
                <span class="n">champs_en_plus</span> <span class="o">=</span> <span class="n">champs_differents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns_concession_opt_2022</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">champs_en_moins</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_en_moins</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">champs_en_plus</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">champs_moins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">champs_moins</span> <span class="o">|</span> <span class="n">champs_en_moins</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">champs_plus</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">champs_plus</span>  <span class="o">|</span> <span class="n">champs_en_plus</span>
                    <span class="c1"># logging.info(f&quot;Voici les champs en moins :{champs_en_moins}&quot;)</span>
                    <span class="c1"># logging.info(f&quot;Voici les champs en plus :{champs_en_plus}&quot;)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dictionnaire valide au format 2024&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    

<div class="viewcode-block" id="SourceProcess.date_norm">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.date_norm">[docs]</a>
    <span class="k">def</span> <span class="nf">date_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datestr</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">datestr</span> <span class="k">else</span> <span class="n">datestr</span></div>



<div class="viewcode-block" id="SourceProcess.date_before_2024">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.date_before_2024">[docs]</a>
    <span class="k">def</span> <span class="nf">date_before_2024</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span><span class="n">nature</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        La fonction vérifie que les dates contenues dans un marché/une </span>
<span class="sd">        concession sont postérieures à 2024 et sont de la forme Y-M-J</span>
<span class="sd">        pour les colonnes date et date_de_publication. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nature</span> <span class="o">==</span> <span class="s2">&quot;marché&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="ow">and</span> <span class="s1">&#39;concession&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;dateDebutExecution&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;dateDebutExecution&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_norm</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;dateDebutExecution&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;datedebutexecution&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;datedebutexecution&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_norm</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;datedebutexecution&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;dateNotification&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;dateNotification&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_norm</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;dateNotification&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;datenotification&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;datenotification&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_norm</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;datenotification&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;dateNotification&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;dateNotification&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_norm</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;dateNotification&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;datenotification&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;datenotification&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_norm</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;datenotification&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    

<div class="viewcode-block" id="SourceProcess.date_after_2024">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.date_after_2024">[docs]</a>
    <span class="k">def</span> <span class="nf">date_after_2024</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            La fonction prend en entrée un dictionnaire et renvoie un </span>
<span class="sd">            booléeen.Les dates postérieures à 2024 doivent être de la</span>
<span class="sd">            forme Y-M-J pour les colonnes date et date_de_publication.</span>
<span class="sd">            @record : marché/concession que l&#39;on souhaite traiter</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;2024-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;20[0-9]</span><span class="si">{2}</span><span class="s1">-[0-1]</span><span class="si">{1}</span><span class="s1">[0-9]</span><span class="si">{1}</span><span class="s1">-[0-9]</span><span class="si">{2}</span><span class="s1">&#39;</span>
            <span class="n">pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;20[0-9]</span><span class="si">{2}</span><span class="s1">/[0-1]</span><span class="si">{1}</span><span class="s1">[0-9]</span><span class="si">{1}</span><span class="s1">/[0-9]</span><span class="si">{2}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Marché&#39;</span><span class="p">:</span>
                <span class="n">col_date</span> <span class="o">=</span> <span class="s1">&#39;dateNotification&#39;</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">col_date</span> <span class="o">=</span> <span class="s1">&#39;dateDebutExecution&#39;</span>
            <span class="n">col_date_publication</span><span class="o">=</span><span class="s1">&#39;datePublicationDonnees&#39;</span>
            <span class="n">col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_date</span><span class="p">,</span><span class="n">col_date_publication</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">and</span> <span class="n">record</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern1</span><span class="p">,</span><span class="n">record</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern2</span><span class="p">,</span><span class="n">record</span><span class="p">[</span><span class="n">col</span><span class="p">])):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">date</span><span class="o">&gt;=</span><span class="n">first</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">col_date_publication</span><span class="p">:</span>
                                <span class="n">record</span><span class="p">[</span><span class="n">col_date</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">col_date_publication</span><span class="p">]</span>
                            <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="kc">None</span>
            <span class="k">return</span> <span class="kc">False</span></div>



    <span class="k">def</span> <span class="nf">_retain_with_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dico</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cette fonction permet de vérifier la validité des marchés et des concessions</span>
<span class="sd">        du dictionnaire fournit en entrée. Elle garde également en mémoire une liste</span>
<span class="sd">        des marchés/concessions invalides pour un éventuel traitement.</span>
<span class="sd">        @dico : dictionnaire </span>
<span class="sd">        @file_name : nom du fichier où sont stockés les fichiers non valides et ignorés</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;marches&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;marche&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">][</span><span class="s1">&#39;marche&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_all_field_and_date_2024</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;marche&#39;</span><span class="p">):</span>
                        <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">][</span><span class="s1">&#39;marche&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                        
            <span class="k">if</span><span class="s1">&#39;contrat-concession&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">][</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_all_field_and_date_2024</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;contrat-concession&#39;</span><span class="p">):</span>
                        <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">][</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Balise &#39;marches&#39; inexistante&quot;</span><span class="p">)</span>
            <span class="n">dico</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ignored </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dico_ignored</span><span class="p">)</span><span class="si">}</span><span class="s2"> record(s) in </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dico</span>


    <span class="k">def</span> <span class="nf">_add_column_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">default_type_name</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_format</span><span class="o">==</span><span class="s1">&#39;2022&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;_type&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="p">(</span><span class="n">default_type_name</span> <span class="ow">or</span> <span class="s2">&quot;nature&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">default_type_name</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_type_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;nature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Marché&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="s2">&quot;Marché&quot;</span> <span class="k">else</span> <span class="s2">&quot;Concession&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="SourceProcess.convert_prestataire">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.convert_prestataire">[docs]</a>
    <span class="k">def</span> <span class="nf">convert_prestataire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Étape de conversion des fichiers qui supprime les &#39; et concatène les fichiers présents</span>
<span class="sd">        dans {self.source} dans un seul DataFrame&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ÉTAPE CONVERT&quot;</span><span class="p">)</span>
        <span class="c1"># suppression des &#39;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">list_path</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1">#list_path sera la liste de tous les fichiers car self.title est la liste des noms de fichiers qui ont été téléchargés</span>
        <span class="n">repertoire_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1">#on récupère le nom de chaque fichier et on le met dans liste path, en plus de compter le nombre de fichiers présent dnas le dossier source</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">repertoire_source</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">repertoire_source</span><span class="p">,</span> <span class="n">path</span><span class="p">)):</span>
                <span class="n">list_path</span> <span class="o">=</span> <span class="n">list_path</span> <span class="o">+</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span> 
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="c1"># print (&quot;title&quot;,self.title) </span>
            <span class="c1"># print (&quot;i :&quot;,i) </span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">file_exist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exist</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Le fichier </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> n&#39;existe pas.&quot;</span><span class="p">)</span>

        <span class="c1"># if count != len(self.url):</span>
        <span class="c1">#     logging.warning(&quot;Nombre de fichiers en local inégal au nombre d&#39;url trouvé&quot;)</span>
        <span class="c1"># if count != len(self.url):</span>
        <span class="c1">#     logging.warning(&quot;Nombre de fichiers en local inégal au nombre d&#39;url trouvé&quot;)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Début de convert: mise au format DataFrame de </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;xml&#39;</span><span class="p">:</span>
            <span class="n">li</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_format</span><span class="o">==</span><span class="s1">&#39;2022&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> not a valide xml&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                        <span class="c1">#raise Exception(f&quot;sources/{self.source}/{self.file_name[i]}.{self.format} not a valide xml&quot;)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xml_file</span><span class="p">:</span>
                        <span class="n">dico</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">dict_constructor</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
 
                    <span class="k">if</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dico</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_2022</span><span class="p">(</span><span class="n">dico</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">_ignored.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="s1">&#39;marches&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">:</span>
                            <span class="c1"># Add marchés</span>
                            <span class="k">if</span> <span class="s1">&#39;marche&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">]:</span>   <span class="c1">#à chaque noueau marché, on ajoute une colonne, qui sera utilisé par un dataframe. Ce dataframe sera ajouté dans la liste li</span>
                                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">][</span><span class="s1">&#39;marche&#39;</span><span class="p">])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_add_column_type</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;Marché&quot;</span><span class="p">)</span>
                                <span class="n">li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                                <span class="c1">##del df</span>

                            <span class="c1"># Add Concession</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_format</span><span class="o">==</span><span class="s1">&#39;2022&#39;</span> <span class="ow">and</span> <span class="s1">&#39;contrat-concession&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">]:</span>
                                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">][</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_add_column_type</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;Concession&quot;</span><span class="p">)</span>
                                <span class="n">li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                                <span class="c1">##del df</span>
                        <span class="c1">##del dico</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># cas presque null</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Le fichier </span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> est vide, il est ignoré&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception lors du chargement du fichier xml </span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
                <span class="c1">##del li</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create empty dataframe</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">li</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                        
                        <span class="c1">#check for format compliance (only for data_format 2022)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_format</span><span class="o">==</span><span class="s1">&#39;2022&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">json_file</span><span class="p">,</span><span class="kc">None</span><span class="p">):</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> not a valid json&quot;</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Json format not valid&quot;</span><span class="p">)</span>
                        
                            <span class="n">dico</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_retain_with_format</span><span class="p">(</span><span class="n">dico</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">_ignored.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                            
                            <span class="k">if</span> <span class="s1">&#39;marches&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">:</span>
                                <span class="c1"># Add marchés</span>
                                <span class="k">if</span> <span class="s1">&#39;marche&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">]:</span>
                                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">][</span><span class="s1">&#39;marche&#39;</span><span class="p">])</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_column_type</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;Marché&quot;</span><span class="p">)</span>
                                    <span class="n">li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                                    <span class="c1">##del df</span>

                                <span class="c1"># Add Concession</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_format</span><span class="o">==</span><span class="s1">&#39;2022&#39;</span> <span class="ow">and</span> <span class="s1">&#39;contrat-concession&#39;</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">]:</span>
                                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">][</span><span class="s1">&#39;contrat-concession&#39;</span><span class="p">])</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_column_type</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;Concession&quot;</span><span class="p">)</span>
                                    <span class="n">li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                                    <span class="c1">##del df</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dico</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_retain_with_format</span><span class="p">(</span><span class="n">dico</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">_ignored.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s1">&#39;marches&#39;</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_add_column_type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                            <span class="n">li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                            <span class="c1">##del df</span>
                        <span class="c1">##del dico</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception lors du chargement du fichier json </span><span class="si">{</span><span class="n">list_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
            <span class="c1">##del li</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Conversion OK&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nombre de marchés dans </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2"> après convert : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="SourceProcess.convert">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.convert">[docs]</a>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Étape de conversion des fichiers qui concatène les fichiers présents dans </span>
<span class="sd">        {self.source} dans un seul DataFrame. Elle utilise le dictionnaire </span>
<span class="sd">        des marchés/concessions valides de chaque fichier pour le convertir en un </span>
<span class="sd">        dataframe. L&#39;ensemble des dataframes est stocké dans une liste. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ÉTAPE CONVERT&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Début de convert: mise au format DataFrame de </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#Mise à jour des dictionnaires</span>
        <span class="n">old_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>   <span class="c1">#liste des titres des fichiers déja présents en local</span>
    
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_files</span><span class="p">)):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extraction des données des anciens fichiers&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;xml&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">old_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xml_file</span><span class="p">:</span>
                        <span class="n">dico</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">dict_constructor</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>  \
                                               <span class="n">force_list</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;marche&#39;</span><span class="p">,</span><span class="s1">&#39;titulaires&#39;</span><span class="p">,</span> <span class="s1">&#39;modifications&#39;</span><span class="p">,</span> <span class="s1">&#39;actesSousTraitance&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;modificationsActesSousTraitance&#39;</span><span class="p">,</span> <span class="s1">&#39;typePrix&#39;</span><span class="p">,</span><span class="s1">&#39;considerationEnvironnementale&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;modaliteExecution&#39;</span><span class="p">))</span>
                        <span class="c1">#Ajout du dictionnaire dans la bonne variable (dico_2022_marche, dico_2022_concession, dico_2019  ou dico_ignored)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tri_format</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s2">&quot;marches&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">old_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Balise &#39;marches&#39; inexistante&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception lors du chargement du fichier xml </span><span class="si">{</span><span class="n">old_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">old_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                            <span class="n">dico</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                            <span class="c1">#Ajout du dictionnaire dans la bonne variable (dico_2022_marche, dico_2022_concession, dico_2019  ou dico_ignored)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tri_format</span><span class="p">(</span><span class="n">dico</span><span class="p">[</span><span class="s2">&quot;marches&quot;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;sources/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">old_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Balise &#39;marches&#39; inexistante&quot;</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception lors du chargement du fichier json </span><span class="si">{</span><span class="n">old_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Début de convert: mise au format DataFrame de </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1">#Liste qui conservera les dataframes. </span>
        <span class="n">li</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Ajout d&#39;un marché à la liste des dataframes</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_marche</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;_type_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_column_type</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;Marché&quot;</span><span class="p">)</span>
        <span class="n">li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    
        <span class="c1"># Ajoutd&#39;une concession à la liste des dataframes</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dico_2022_concession</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;_type_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_column_type</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;Concession&quot;</span><span class="p">)</span>
        <span class="n">li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
           
        <span class="c1">#Concaténation des dataframes de la liste li en une dataframe                  </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># create empty dataframe</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Conversion OK&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nombre de marchés dans </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2"> après convert : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

        <span class="c1">#print(&quot;DF&quot;, self.df)</span>


<div class="viewcode-block" id="SourceProcess.validateJson">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.validateJson">[docs]</a>
    <span class="k">def</span> <span class="nf">validateJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jsonData</span><span class="p">,</span><span class="n">jsonScheme</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction vérifiant si le fichier jsn &quot;jsonData&quot; respecte</span>
<span class="sd">        le schéma spécifié dans le  schéma en paramètre &quot;jsonScheme&quot;. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#Draft7Validator.check_schema(jsonScheme)</span>
            <span class="c1">#Draft202012Validator.check_schema(jsonScheme)</span>
            <span class="n">validate</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">jsonData</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">jsonScheme</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur de validation json - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tri/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">/log_erreurs_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">error_file</span><span class="p">:</span>
              <span class="n">error_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1">#print(str(err))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


        

<div class="viewcode-block" id="SourceProcess.validateXml">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.validateXml">[docs]</a>
    <span class="k">def</span> <span class="nf">validateXml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xsd_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction vérifiant si le fichier xml &quot;xml_path&quot; respecte </span>
<span class="sd">        le schéma spécifié dans le paramètre &quot;xsd_path&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xml_schema_doc</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xsd_path</span><span class="p">)</span>
        <span class="n">xml_schema</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">XMLSchema</span><span class="p">(</span><span class="n">xml_schema_doc</span><span class="p">)</span>

        <span class="n">xml_doc</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xml_schema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">xml_doc</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur de validation xml - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tri/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">/log_erreurs_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">error_file</span><span class="p">:</span>
              <span class="n">error_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">result</span></div>

    
<div class="viewcode-block" id="SourceProcess.check">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.check">[docs]</a>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jsonData</span><span class="p">,</span><span class="n">xml_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fonction qui prend en paramètre une donnée json ou xml </span>
<span class="sd">        et qui vérifie grâce à un schéma que la donnée est valide.</span>
<span class="sd">        @JsonData : donnée json en entrée (nul si xml)</span>
<span class="sd">        @xml_path : chemin du fichier xml en entrée (nul si json)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#on vérifie que la donnée en entrée est valide par rapport au schéma</span>
        <span class="n">scheme_path</span> <span class="o">=</span> <span class="s1">&#39;schemes/schema_decp_v2.0.2.json&#39;</span>
        <span class="c1">#print(&quot;ouverture fichier&quot;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="o">==</span><span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scheme_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonfile1</span><span class="p">:</span>
                <span class="c1">#print(&quot;ouverture fichier 2&quot;)</span>
                <span class="n">jsonScheme</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonfile1</span><span class="p">)</span>
                <span class="n">jsonfile1</span><span class="o">.</span><span class="n">close</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validateJson</span><span class="p">(</span><span class="n">jsonData</span><span class="p">,</span><span class="n">jsonScheme</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>    <span class="c1"># xml</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xml_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xml_file</span><span class="p">:</span>
                    <span class="n">xml_content</span> <span class="o">=</span> <span class="n">xml_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">xmlschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">xml_content</span><span class="p">,</span> <span class="n">scheme_path</span><span class="p">)</span><span class="o">==</span><span class="kc">None</span>
            <span class="k">except</span> <span class="n">xmlschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">XMLSchemaException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur de validation xml - </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span></div>



        <span class="c1">#all_columns_marche = [&#39;procedure&#39;, &#39;modifications&#39;, &#39;nature&#39;, &#39;codecpv&#39;, &#39;considerationssociales&#39;,</span>
        <span class="c1">#&#39;considerationsenvironnementales&#39;,&#39;dureemo is&#39;,</span>
        <span class="c1">#&#39;datepublicationdonnees&#39;, &#39;titulaires&#39;, &#39;id&#39;, &#39;type&#39;, &#39;formeprix&#39;,</span>
        <span class="c1">#&#39;datenotification&#39;, &#39;objet&#39;, &#39;montant&#39;, &#39;lieuexecution_code&#39;,</span>
        <span class="c1">#&#39;lieuexecution_typecode&#39;, &#39;lieuexecution_nom&#39;, &#39;acheteur_id&#39;,</span>
        <span class="c1">#&#39;acheteur_nom&#39;, &#39;datetransmissiondonneesetalab&#39;]</span>

        <span class="c1">#all_columns_concession = [&#39;procedure&#39;, &#39;modifications&#39;, &#39;nature&#39;, &#39;codecpv&#39;, &#39;considerationssociales&#39;,</span>
        <span class="c1">#&#39;considerationsenvironnementales&#39;,&#39;dureemois&#39;,</span>
        <span class="c1">#&#39;datepublicationdonnees&#39;, &#39;titulaires&#39;, &#39;id&#39;, &#39;type&#39;, &#39;formeprix&#39;,</span>
        <span class="c1">#&#39;datenotification&#39;, &#39;objet&#39;, &#39;montant&#39;, &#39;lieuexecution_code&#39;,</span>
        <span class="c1">#&#39;lieuexecution_typecode&#39;, &#39;lieuexecution_nom&#39;, &#39;acheteur_id&#39;,</span>
        <span class="c1">#&#39;acheteur_nom&#39;, &#39;datetransmissiondonneesetalab&#39;]</span>

        <span class="c1">#columns = [column.lower() for column in self.df.columns]</span>

        <span class="c1">#for col in all_columns_marche:</span>
        <span class="c1">#    if col not in columns:</span>
        <span class="c1">#        conform = False</span>
        <span class="c1">#        raise Exception(&quot;Format is not valid&quot;)</span>
        <span class="c1">#for col in all_columns_concession:</span>
        <span class="c1">#    if col not in columns:</span>
        <span class="c1">#        conform = False</span>
        <span class="c1">#        raise Exception(&quot;Format is not valid&quot;)</span>
        <span class="c1">#return conform</span>

<div class="viewcode-block" id="SourceProcess.convert_boolean">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.convert_boolean">[docs]</a>
    <span class="k">def</span> <span class="nf">convert_boolean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">col_name</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permet de remplacer les valeurs booléennes ou &quot;Vrai&quot; ou &quot;Faux&quot; par &quot;oui&quot; ou &quot;non&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Conversion si il s&#39;agit de string</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span><span class="s1">&#39;True&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;True&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span> <span class="p">})</span> </div>



<div class="viewcode-block" id="SourceProcess.fix">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.fix">[docs]</a>
    <span class="k">def</span> <span class="nf">fix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Étape fix qui crée la colonne source dans le</span>
<span class="sd">        DataFrame et qui supprime les doublons purs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
            
        <span class="k">def</span> <span class="nf">check_dico</span><span class="p">(</span><span class="n">dico</span><span class="p">):</span>
        <span class="c1">#Prend en entrée le dictionnaire du champ &quot;acheteur&quot;</span>
            <span class="k">if</span> <span class="n">dico</span><span class="o">==</span><span class="p">{}</span> <span class="ow">or</span> <span class="n">dico</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dico</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">def</span> <span class="nf">update_id</span><span class="p">(</span><span class="n">ligne</span><span class="p">):</span>
            <span class="c1">#Modifie le champ &quot;id&quot; du champ acheteur</span>
            <span class="k">if</span> <span class="n">check_dico</span><span class="p">(</span><span class="n">ligne</span><span class="p">[</span><span class="s2">&quot;acheteur&quot;</span><span class="p">]):</span>
                   <span class="n">ligne</span><span class="p">[</span><span class="s2">&quot;acheteur&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">ligne</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="p">}</span>
            <span class="k">return</span> <span class="n">ligne</span>      

        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  ÉTAPE FIX&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Début de fix: Ajout source et suppression des doublons de </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Ajout de source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="c1"># Transformation des acheteurs</span>
        <span class="k">if</span> <span class="s2">&quot;acheteur&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_marche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;March&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span> <span class="c1">#on récupère que les lignes de nature &quot;marché&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_marche</span><span class="o">.</span><span class="n">index</span><span class="p">,[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;acheteur&#39;</span><span class="p">]]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_marche</span><span class="o">.</span><span class="n">index</span><span class="p">,[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;acheteur&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">update_id</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Force type integer on column offresRecues</span>
        <span class="k">if</span> <span class="s2">&quot;offresRecues&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;offresRecues&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;offresRecues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;marcheInnovant&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1">#print(&quot;TYPE COLONNE MARCHE INNOVANT:&quot;, self.df[&#39;marcheInnovant&#39;].dtype)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_boolean</span><span class="p">(</span><span class="s1">&#39;marcheInnovant&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;attributionAvance&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1">#print(&quot;TYPE COLONNE ATTRIBUTION AVANCEE:&quot;, self.df[&#39;attributionAvance&#39;].dtype)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_boolean</span><span class="p">(</span><span class="s1">&#39;attributionAvance&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;sousTraitanceDeclaree&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1">#print(&quot;TYPE COLONNE sous traitance:&quot;, self.df[&#39;sousTraitanceDeclaree&#39;].dtype)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert_boolean</span><span class="p">(</span><span class="s1">&#39;sousTraitanceDeclaree&#39;</span><span class="p">)</span>


       
        <span class="c1"># Suppression des doublons</span>
        <span class="n">df_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">index_to_keep</span> <span class="o">=</span> <span class="n">df_str</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index_to_keep</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fix de </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2"> OK&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nombre de marchés dans </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2"> après fix : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    

<div class="viewcode-block" id="SourceProcess.mark_mandatory_field">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.mark_mandatory_field">[docs]</a>
    <span class="k">def</span> <span class="nf">mark_mandatory_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">field_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">empty_mandatory</span> <span class="o">=</span> <span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_mandatory</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">empty_mandatory</span><span class="p">,</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MQ&#39;</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SourceProcess.mark_optional_field">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.mark_optional_field">[docs]</a>
    <span class="k">def</span> <span class="nf">mark_optional_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">field_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">empty_optional</span>  <span class="o">=</span> <span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_optional</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">empty_optional</span><span class="p">,</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CDL&#39;</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="c1">#@compute_execution_time</span>
<div class="viewcode-block" id="SourceProcess.marche_mark_fields">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.marche_mark_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">marche_mark_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;nature&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;objet&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;technique&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;modaliteExecution&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;codeCPV&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;procedure&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dureeMois&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dateNotification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;considerationsSociales&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;considerationsEnvironnementales&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;marcheInnovant&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;origineUE&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;origineFrance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;ccag&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;offresRecues&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;montant&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;formePrix&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;typePrix&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;attributionAvance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;datePublicationDonnees&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;acheteur.id&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;lieuExecution.code&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;lieuExecution.typeCode&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;titulaire_id_1&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;titulaire_typeIdentifiant_1&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;idActeSousTraitanceModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;typeIdentifiantActeSousTraitanceModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dureeMoisActeSousTraitanceModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dateNotificationActeSousTraitanceModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;montantActeSousTraitanceModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;datePublicationDonneesActeSousTraitanceModification&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;idAccordCadre&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;tauxAvance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;typeGroupementOperateurs&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;sousTraitanceDeclaree&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;idSousTraitance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dureeMoisSousTraitance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dateNotificationSousTraitance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;montantSousTraitance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;variationPrixSousTraitance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;datePublicationDonneesSousTraitance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;idActeSousTraitance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;typeIdentifiantActeSousTraitance&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;idModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dureeMoisModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;montantModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;titulairesModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;typeIdentifiantModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dateNotificationModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;datePublicationDonneesModification&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="c1">#@compute_execution_time</span>
<div class="viewcode-block" id="SourceProcess.concession_mark_fields">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.concession_mark_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">concession_mark_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;nature&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;objet&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;procedure&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dureeMois&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dateDebutExecution&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dateSignature&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;considerationsSociales&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;considerationsEnvironnementales&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;valeurGlobale&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;montantSubventionPublique&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;datePublicationDonnees&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;autoriteConcedante.id&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;concessionnaire_id_1&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;concessionnaire_typeIdentifiant_1&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;depensesInvestissement&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;datePublicationDonneesExecution&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;intituleTarif&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_mandatory_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;tarif&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;idModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dureeMoisModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;valeurGlobaleModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;dateSignatureModification&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mark_optional_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s2">&quot;datePublicationDonneesModification&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>

    
<div class="viewcode-block" id="SourceProcess.comment">
<a class="viewcode-back" href="../../general_process.html#general_process.SourceProcess.SourceProcess.comment">[docs]</a>
    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># séparation des marchés et des concessions, car traitement différent</span>
        <span class="n">df_marche</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;concession&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

        <span class="n">df_concession1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;concession&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

        <span class="c1"># df_concession prend aussi en compte les lignes restantes ou la colonne &quot;_type&quot; contient &quot;concession&quot; dans le df_marche et concatène les deux dataframes</span>
        <span class="n">df_concession</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_concession1</span><span class="p">,</span> <span class="n">df_marche</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_marche</span><span class="p">[</span><span class="s1">&#39;_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;concession&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]])</span>
        <span class="c1"># remove old df for memory</span>
        <span class="k">del</span> <span class="n">df_concession1</span>
        <span class="n">df_marche</span> <span class="o">=</span> <span class="n">df_marche</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_marche</span><span class="p">[</span><span class="s1">&#39;_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;concession&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">marche_mark_fields</span><span class="p">(</span><span class="n">df_marche</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concession_mark_fields</span><span class="p">(</span><span class="n">df_concession</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">DECP_doc</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Sommaire:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">general_process</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Code du module</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Recherche rapide</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Mathilde Badlou, Alexandre Boutin, Sabri Flici.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>